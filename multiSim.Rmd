---
title: "multiSim"
author: "Jonathan Cordell"
date: "17/02/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
source("sim.R")$value
```

```{r}
default.classSize <- 30
default.noYears <- 6
default.subjectTeachers <- 0
default.maxTime <- 100
#Rate of infection + background
default.backgroundROI <- 3300/67000000 #https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates
default.gammaParams <- c("spread.shape"=10,"spread.scale"=0.8,"recover.shape"=17,"recover.scale"=0.8)
default.testType <- "Lateral"
default.probs <- list("Lateral"=list("TP"=67/100,"TN"=99850/99900),"PCR"=list("TP"=95/100,"TN"=99.2/100), "None"=list("TP"=0,"TN"=1))
#https://www.bmj.com/content/373/bmj.n1411/rr
#https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/methodologies/covid19infectionsurveypilotmethodsandfurtherinformation
default.quarantineTime=10
default.catchRate <- 0.7
default.testDays <- c(5,7)
default.startingInfected <- 5
default.quarantineThreshold <- 30
default.teacherInfective <- 3
default.teacherInfectible <- 1.5
default.teacherTeacher <- 1.5
default.nonClass <- 0.7
default.weekend <- c(0.3,10)
default.maxIPeriod <- 20
# save(classSize, noYears, subjectTeachers, maxTime, backgroundROI, gammaParams, testType, probs, quarantineTime, catchRate, testDays, startingInfected, quarantineThreshold, teacherInfective, teacherInfectible, teacherTeacher, nonClass, weekend, maxIPeriod, file="variables.Rdata")
```
```{r}
findAvg <- function(classSize=default.classSize,noYears=default.noYears,subjectTeachers=default.subjectTeachers,maxTime=default.maxTime,backgroundROI=default.backgroundROI,gammaParams=default.gammaParams,testType=default.testType,probs=default.probs,quarantineTime=default.quarantineTime,catchRate=default.catchRate,testDays=default.testDays,startingInfected=default.startingInfected,quarantineThreshold=default.quarantineThreshold,teacherInfective=default.teacherInfective,teacherInfectible=default.teacherInfectible,teacherTeacher=default.teacherTeacher,nonClass=default.nonClass,weekend=default.weekend,maxIPeriod=default.maxIPeriod){
  x<-NULL
  for (i in 1:10){
    x<-rbind(x,sim(classSize, noYears, subjectTeachers, maxTime, backgroundROI, gammaParams, testType, probs, quarantineTime, catchRate, testDays, startingInfected, quarantineThreshold, teacherInfective, teacherInfectible, teacherTeacher, nonClass, weekend, maxIPeriod))
  }
  return(data.frame(t(colMeans(x))))
}  
```


```{r, warning=FALSE, message=FALSE}
print("Base case parameters:")
paste("Class size of",default.classSize)
paste(default.noYears,"years in the school")
paste(default.subjectTeachers,"subject teachers")
paste("Simulation runs for",default.maxTime,"time steps")
paste("Background Rate of Infection of",default.backgroundROI)
paste("Individuals viral load over time modelled as gamma distribution with shape",default.gammaParams["spread.shape"],"and scale",default.gammaParams["spread.scale"])
paste("Individuals probability of recovering over time modelled as gamma distribution with shape",default.gammaParams["recover.shape"],"and scale",default.gammaParams["recover.scale"])
paste("Testing type is",default.testType,"which has true positive rate of",default.probs[[default.testType]]$TP,"and true negative rate of",default.probs[[default.testType]]$TN)
paste("Testing is done on days",toString(default.testDays))
paste("Time spent quarantining is",default.quarantineTime,"days")
paste("The base probability of catching the disease is",default.catchRate)
paste("Starting number of infected is",default.startingInfected)
paste("Threshold of quarantining individuals considered noteworthy is",default.quarantineThreshold)
paste("Teacher to their student infection multiplier set to", default.teacherInfective)
paste("Student to their teacher infection multiplier set to", default.teacherInfectible)
paste("Teacher to teacher infection multiplier set to", default.teacherTeacher)
paste("Infection multiplier for students in seperate classes set to",  default.nonClass)
paste("During weekends, probability of infection from school is multiplied by",default.weekend[1],"whilst infection from other sources is multiplied by",default.weekend[2])
paste("The maximum possible time to be infectious is taken to be", default.maxIPeriod)

results <- cbind(name="Base Case",findAvg())
results <- rbind(results,cbind(name="PCR once per week",findAvg(testType="PCR", testDays=c(6))))
results <- rbind(results,cbind(name="No testing",findAvg(testType="None")))
results <- rbind(results,cbind(name="15 starting infected",findAvg(startingInfected=15)))
print(results)
```