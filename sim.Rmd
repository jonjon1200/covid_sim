---
title: "Model"
author: "Jonathan Cordell"
date: "27/10/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tibble)
library(ggplot2)
library(knitr)
library(formatR)
library(dplyr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
```
```{r parameters}
classSize <- 300
maxTime <- 75
#Rate of infection + background
backgroundROI <- 3300/67000000 #https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates
gammaParams <- c("spread.shape"=10,"spread.scale"=0.8,"recover.shape"=17,"recover.scale"=0.8)
testType <- "N"
probs <- list("L"=list("TP"=67/100,"TN"=99850/99900),"P"=list("TP"=95/100,"TN"=99.2/100), "N"=list("TP"=0,"TN"=1))
#https://www.bmj.com/content/373/bmj.n1411/rr
#https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/methodologies/covid19infectionsurveypilotmethodsandfurtherinformation
quarantineTime=10
catchRate <- 0.7
```

```{r functions}
gammaRate <- function(infected){
  if(nrow(infected)==0){return (0)}
  allGamma <- apply(infected,1,function(a) dgamma(as.double(a["timeInState"][[1]]),shape=gammaParams["spread.shape"],scale=gammaParams["spread.scale"]) / dgamma(gammaParams["spread.shape"]*gammaParams["spread.scale"],shape=gammaParams["spread.shape"],scale=gammaParams["spread.scale"])* as.double(a["spreadMult"]))
  total<- sum(allGamma)
  return(total)
}

newState <- function(time, student){
  if(student["state"]=="S"){
    infected <- subset(timeList[[time]],(state=="I"))
    studentNo <- gammaRate(infected)
    lambda <- backgroundROI + as.double(student["catchMult"][[1]]) * catchRate *  studentNo/classSize
    coinFlipI <- rbinom(1,1,lambda)
    coinFlipQ <- rbinom(1,1,(1-probs[[testType]][["TN"]]) * as.numeric(time%%7==0))
    if (coinFlipQ==1){
      student["state"]="Q"
      student["timeInState"]=1
    }else if (coinFlipI>0){
      student["state"]="I"
      student["timeInState"]=1
    }else{
      student["timeInState"]<-as.double(student["timeInState"])+1
    }
  }else if(student["state"]=="I"){
    lambda <- dgamma(as.double(student["timeInState"][[1]]),shape=gammaParams["recover.shape"],scale=gammaParams["recover.scale"])
    scaledInfectiousness <-  dgamma(as.double(student["timeInState"][[1]]),shape=gammaParams["spread.shape"],scale=gammaParams["spread.scale"]) / dgamma(gammaParams["spread.shape"]*gammaParams["spread.scale"],shape=gammaParams["spread.shape"],scale=gammaParams["spread.scale"])
    coinFlipI <- rbinom(1,1,lambda)
    coinFlipQ <- rbinom(1,1,as.numeric(time%%7==0)*probs[[testType]][["TP"]]*scaledInfectiousness)
    if (coinFlipQ == 1){
      student["state"]="Q"
      student["timeInState"]=1
    }else if ( coinFlipI == 1 || as.double(student["timeInState"])==15){
      student["state"]="R"
      student["timeInState"]=1
    }else{
      student["timeInState"]<-as.double(student["timeInState"])+1
    }
  }else if(student["state"]=="Q"){
    if (student["timeInState"]==quarantineTime){
      student["state"]="R"
      student["timeInState"]=1
    }else{
      student["timeInState"]=as.double(student["timeInState"])+1
    }
  }else{
    student["timeInState"]<-as.double(student["timeInState"])+1
  }
  return (student)
}
```


```{r}
studentID = c(1:classSize)
spreadMult = rnorm(classSize, mean=1, sd=0.1)
catchMult = rnorm(classSize, mean=1, sd=0.1)
state = c("I",rep("S",classSize-1))
timeInState = rep(1,classSize)
class1 <- tibble(studentID, spreadMult, catchMult, state, timeInState)
multFrame <- tibble(studentID, spreadMult, catchMult)
```

```{r}
timeList <- list(class1)
for (i in (2:maxTime)){
  tempClass <- as_tibble(t(apply(timeList[[i-1]],1,newState,time=i-1)))
  timeList <- append(timeList, list(tempClass))
}
```

```{r Plotting}
population <- data.frame("S"=classSize-1,"I"=1, "Q"=0, "R"=0)
for (i in (2:maxTime)){
  Sno <- nrow(filter(timeList[[i]], state=="S"))
  Ino <- nrow(filter(timeList[[i]], state=="I"))
  Qno <- nrow(filter(timeList[[i]], state=="Q"))
  Rno <- classSize-Sno-Ino-Qno
  population <- add_row(population, "S"=Sno, "I"=Ino, "Q"=Qno, "R"=Rno)
}
  barplot(t(as.matrix(population)), col=c("cyan","yellow", "grey","red"), xlab="Days", ylab="Students", names.arg=(1:maxTime))
legend("topright", colnames(population), fill=c("cyan","yellow", "grey","red"), bg="white")
```